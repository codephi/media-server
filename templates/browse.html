{% extends "base.html" %}

{% block title %}Browse - Media Serve{% endblock %}

{% block actions %}
<div class="flex items-center gap-1 rounded-full bg-slate-800/70 p-1 text-xs uppercase tracking-wide">
    <a href="?view=list{% if show_hidden %}&show_hidden=1{% endif %}"
        class="inline-flex items-center rounded-full px-3 py-1 font-semibold transition {% if view_mode == " list"
        %}bg-slate-100 text-slate-900 shadow{% else %}text-slate-300 hover:text-white{% endif %}">
        Lista
    </a>
    <a href="?view=grid{% if show_hidden %}&show_hidden=1{% endif %}"
        class="inline-flex items-center rounded-full px-3 py-1 font-semibold transition {% if view_mode == " grid"
        %}bg-slate-100 text-slate-900 shadow{% else %}text-slate-300 hover:text-white{% endif %}">
        Galeria
    </a>
</div>

<form id="upload-form" action="/upload/{{ current_path }}" method="post" enctype="multipart/form-data"
    class="flex items-center gap-2">
    <input type="file" name="files" multiple id="file-input" class="hidden">
    <button type="button"
        class="inline-flex items-center gap-2 rounded-full border border-slate-700/80 bg-slate-900/60 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-100 transition hover:border-slate-500 hover:text-white"
        onclick="document.getElementById('file-input').click()">
        <iconify-icon icon="heroicons:arrow-up-tray"></iconify-icon>
        Carregar Arquivos
    </button>
    <button type="submit" id="upload-btn"
        class="hidden inline-flex items-center gap-2 rounded-full border border-emerald-400/50 bg-emerald-500/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-emerald-200 transition hover:border-emerald-400 hover:bg-emerald-500/30">
        Enviar
    </button>
</form>

{% if show_hidden %}
<a href="?view={{ view_mode }}"
    class="inline-flex items-center rounded-full border border-slate-700/80 px-3 py-1 text-xs uppercase tracking-wide text-slate-300 transition hover:border-slate-500 hover:text-white">
    Ocultar arquivos ocultos
</a>
{% else %}
<a href="?view={{ view_mode }}&show_hidden=1"
    class="inline-flex items-center rounded-full border border-slate-700/80 px-3 py-1 text-xs uppercase tracking-wide text-slate-300 transition hover:border-slate-500 hover:text-white">
    Mostrar arquivos ocultos
</a>
{% endif %}
{% endblock %}

{% block content %}
{% if view_mode == "grid" %}
<div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6">
    {% for item in items %}
    <div
        class="group flex flex-col gap-3 rounded-xl border border-slate-800/60 bg-slate-900/60 p-3 transition hover:border-slate-600 hover:bg-slate-900/80">
        <a class="flex flex-col gap-3"
            href="{% if item.is_dir %}/browse/{{ item.encoded_path }}{% else %}/file/{{ item.encoded_path }}{% endif %}">
            {% if item.has_thumbnail %}
            <img src="/thumbs/{{ item.encoded_path }}?w={{ thumb_size }}" alt="{{ item.name }}" loading="lazy"
                class="h-44 w-full rounded-lg border border-slate-800/70 object-cover object-center transition group-hover:border-slate-600">
            {% else %}
            <div
                class="flex h-44 w-full items-center justify-center rounded-lg border border-dashed border-slate-700 bg-slate-900/60 relative">
                <iconify-icon icon="{{ item.icon }}" width="48" height="48"
                    class="text-slate-400 opacity-75"></iconify-icon>

            </div>
            {% endif %}
            <div class="truncate text-sm font-medium text-slate-100" title="{{ item.name }}">{{ item.name }}</div>
        </a>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="overflow-hidden rounded-xl border border-slate-800/60 bg-slate-900/60">
    <table class="min-w-full divide-y divide-slate-800 text-left text-sm">
        <thead class="bg-slate-900/80 text-xs uppercase tracking-wide text-slate-400">
            <tr>
                <th scope="col" class="px-4 py-3 font-semibold">Nome</th>
                <th scope="col" class="px-4 py-3 font-semibold">Tamanho</th>
                <th scope="col" class="px-4 py-3 font-semibold">Modificado</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-800/80">
            {% for item in items %}
            <tr class="transition hover:bg-slate-900">
                <td class="flex items-center gap-3 px-4 py-3 text-slate-100">
                    <iconify-icon icon="{{ item.icon }}" class="text-lg text-slate-400 opacity-80"></iconify-icon>
                    <a class="truncate font-medium"
                        href="{% if item.is_dir %}/browse/{{ item.encoded_path }}{% else %}/file/{{ item.encoded_path }}{% endif %}">
                        {{ item.name }}
                    </a>
                </td>
                <td class="px-4 py-3 text-slate-300">{{ item.size }}</td>
                <td class="px-4 py-3 text-slate-300">{{ item.modified }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if items.is_empty() %}
<div
    class="mt-10 flex flex-col items-center justify-center gap-3 rounded-xl border border-dashed border-slate-700 bg-slate-900/40 px-8 py-12 text-center text-sm text-slate-400">
    <iconify-icon icon="heroicons:folder-open" class="text-3xl text-slate-500"></iconify-icon>
    <p>Diretório vazio</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const fileInput = document.getElementById('file-input');
    const uploadButton = document.getElementById('upload-btn');
    const uploadForm = document.getElementById('upload-form');

    if (fileInput && uploadButton && uploadForm) {
        fileInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                uploadButton.classList.remove('hidden');
                uploadButton.innerHTML = `<iconify-icon icon="heroicons:arrow-up-tray"></iconify-icon> Enviar ${this.files.length} arquivo(s)`;
            } else {
                uploadButton.classList.add('hidden');
            }
        });

        uploadForm.addEventListener('submit', function (e) {
            if (fileInput.files.length === 0) {
                e.preventDefault();
                alert('Selecione pelo menos um arquivo');
                return;
            }

            // Show upload progress
            uploadButton.innerHTML = `<iconify-icon icon="heroicons:arrow-path" class="animate-spin"></iconify-icon> Enviando...`;
            uploadButton.disabled = true;
        });
    }

    // Debug: verificar se os ícones do Iconify estão carregando
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Iconify loaded:', typeof window.IconifyIcon !== 'undefined');

        // Verificar se há elementos iconify-icon na página
        const iconifyElements = document.querySelectorAll('iconify-icon');
        console.log('Iconify elements found:', iconifyElements.length);

        iconifyElements.forEach((el, index) => {
            console.log(`Icon ${index}:`, el.getAttribute('icon'));
        });

        // Timeout para verificar se os ícones carregaram e mostrar fallback se necessário
        setTimeout(() => {
            iconifyElements.forEach((el) => {
                // Se o ícone não carregou (não tem conteúdo), mostrar fallback
                if (!el.innerHTML.trim()) {
                    console.log('Icon failed to load:', el.getAttribute('icon'));
                    const fallback = el.parentElement.querySelector('.fallback-icon');
                    if (fallback) {
                        el.style.display = 'none';
                        fallback.classList.remove('hidden');
                    }
                }
            });
        }, 2000);
    });
</script>
{% endblock %}